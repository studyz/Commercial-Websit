/* Copyright (c) 2017 Synology Inc. All rights reserved. */

tinymce.PluginManager.add("syno_ps_tinymce",function(f,b){var i,c,h;var d,l=this;function a(o){var m,n;if(i&&i.protocol&&i.host){m=i.protocol+"://"+i.host;o(m)}else{i={};o(window.location.origin);return}n=new XMLHttpRequest();n.open("GET",m+"/webman/pingpong.php?action=cors");n.onreadystatechange=function(){var q=false;if(4!==n.readyState){return}if(200===n.status){try{q=JSON.parse(n.responseText).success}catch(p){q=false}if(true!==q){f.windowManager.alert("Cannot connect to: "+m);return}}};n.onerror=function(){f.windowManager.alert("Cannot connect to: "+m)};n.send()}function k(n){var m=new XMLHttpRequest();m.open("GET",b+"/settings.php");m.onreadystatechange=function(){var p;if(4!==m.readyState){return}if(200===m.status){try{p=JSON.parse(m.responseText);if(true===p.success){i=p.data}}catch(o){i={}}}if("[object Object]"!==Object.prototype.toString.apply(i)){i={}}a(n)};m.send()}l.openPSSettingWindow=function(){var o,n={},m;n.host=i.host;n.protocol=i.protocol;o=f.windowManager.open({id:"syno-photostation-configuration-window",title:"Photo Station Configuration",file:b+"/settings.html",width:502,height:185,inline:true,resizable:false,close_previous:false});m=o.getEl().querySelector("iframe");m.onload=function(p){m.contentWindow.init(n,function(q){var s,r="";o.close();if(!q){return}if(q.host){n.host=q.host}r+="host="+window.encodeURIComponent(n.host);if(q.protocol&&-1!==["http","https"].indexOf(q.protocol)){n.protocol=q.protocol}r+="&protocol="+window.encodeURIComponent(n.protocol);s=new XMLHttpRequest();s.open("POST",b+"/settings.php");s.setRequestHeader("Content-type","application/x-www-form-urlencoded");s.onreadystatechange=function(){var u={success:false};if(4!==s.readyState){return}if(200==s.status){try{u=JSON.parse(s.responseText)}catch(t){}}if(u&&true===u.success){l.openPSInsertWindow()}};s.send(r)})}};l.openPSInsertWindow=function(){var m;i=null;k(function(p){var n,q,o;h=p;if(!window.location.origin){n=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")}else{n=window.location.origin}o=p+"/photo/cms/ImageChooser.php?origin="+window.encodeURIComponent(n);if(d&&d._rendered&&d._visible){q=d.getEl().querySelector("#syno-photostation-window-body iframe");if(q.src!==o){q.src=o}return}d=f.windowManager.open({id:"syno-photostation-window",file:o,title:"Insert images from Photo Station",width:962,height:520,inline:true,resizable:true,close_previous:true,onPostRender:function(r){var s=r.control.getEl();m=tinymce.ui.Factory.create({type:"button",classes:"syno-photostation-setting-btn"});m.renderBefore(s.querySelector(".mce-window-head .mce-title"));m.on("click",l.openPSSettingWindow)}},{plugin_url:o})})};function j(){var m;if(!c){c=f.dom.uniqueId();m=f.dom.create("link",{id:c,rel:"stylesheet",href:b+"/style.css"});document.getElementsByTagName("head")[0].appendChild(m)}}function e(){if(d){d.close();d=null}}function g(m){if(!m.data){return}if(h&&m.origin&&0!==m.origin.indexOf(h)){return}switch(m.data.cls){case"chooser":switch(m.data.act){case"hide":e();break;case"insert":if(m.data.data){f.selection.setContent(m.data.data.html);e()}break;default:console.log("Unknown action for chooser: "+m.data.act);break}break;default:console.log("Unknown message class: "+m.data.cls);break}}f.addButton("syno_ps_tinymce",{image:b+"/images/icon_photostation_plugin.png",tooltip:"Insert from Photo Station",onclick:l.openPSInsertWindow});f.on("init",function(){j();window.addEventListener("message",g)})});